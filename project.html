<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://threejs.org/build/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://threejs.org/examples/js/controls/DragControls.js"></script>
    <script src="https://threejs.org/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://threejs.org/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1 align="center">CAP4720 Final Project: Interior Design Simulator</h1>
    <div class="menu">
      <div class="menu-main">
        <div class="menu-main-labels">
          <h3>Furniture</h3>
          <h3>Uphostery</h3>
          <h3>Wood Finishes</h3>
        </div>
        <div class="menu-main-thumbnails">
          <div class="menu-main-thumbnails-furniture-selection">
            <img
              src="assets/thumbnails/chair_thumbnail.png"
              alt="Chair"
              height="60"
              width="60"
              onclick="addPiece('chair')"
            />
            <img
              src="assets/thumbnails/couch_thumbnail.png"
              alt="Couch"
              height="60"
              width="60"
              onclick="addPiece('couch')"
            />
            <img
              src="assets/thumbnails/table_thumbnail.png"
              alt="Coffee Table"
              height="60"
              width="60"
              onclick="addPiece('table')"
            />
            <img
              src="assets/thumbnails/plant_thumbnail.png"
              alt="Plant"
              height="60"
              width="60"
              onclick="addPiece('plant')"
            />
            <img
              src="assets/thumbnails/lamp_thumbnail.png"
              alt="Lamp"
              height="60"
              width="60"
              onclick="addPiece('lamp')"
            />
          </div>
          <div class="menu-main-thumbnails-uphostery-selection">
            <img
              src="assets/thumbnails/gray_linen_thumbnail.png"
              alt="Gray Linen"
              height="60"
              width="60"
              onclick="swapTexture('gray_linen')"
            />
            <img
              src="assets/thumbnails/green_linen_thumbnail.png"
              alt="Green Linen"
              height="60"
              width="60"
              onclick="swapTexture('green_linen')"
            />
            <img
              src="assets/thumbnails/blue_linen_thumbnail.png"
              alt="Blue Linen"
              height="60"
              width="60"
              onclick="swapTexture('blue_linen')"
            />
            <img
              src="assets/thumbnails/natural_linen_thumbnail.png"
              alt="Natural Linen"
              height="60"
              width="60"
              onclick="swapTexture('natural_linen')"
            />
            <img
              src="assets/thumbnails/rust_linen_thumbnail.png"
              alt="Rust Linen"
              height="60"
              width="60"
              onclick="swapTexture('rust_linen')"
            />
          </div>
          <div class="menu-main-thumbnails-wood-selection">
            <img
              src="assets/thumbnails/oak_thumbnail.png"
              alt="Oak"
              height="60"
              width="60"
              onclick="swapTexture('oak')"
            />
            <img
              src="assets/thumbnails/bamboo_thumbnail.png"
              alt="Bamboo"
              height="60"
              width="60"
              onclick="swapTexture('bamboo')"
            />
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      'use strict';

      let scene, object, camera, renderer, cameraControls, activeObject;
      let furnitureNames = ['chair', 'couch', 'plant', 'table', 'lamp'];
      let furnitureObjects = [];
      let furnitureMap = new Map();
      let uuidMap = new Map();

      let WIDTH = window.innerWidth;
      let HEIGHT = window.innerHeight;

      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x80aba4);
        initRenderer();
        initScene();
        initMeshes();
        handleWindowResize();
        window.requestAnimationFrame(render);

        var controls = new THREE.DragControls(
          furnitureObjects,
          camera,
          renderer.domElement
        );
        controls.addEventListener('hoveron', function(event) {
          if (event.object.parent.parent != scene) {
            controls.enabled = false;
          } else {
            controls.enabled = true;
          }
        });
        controls.addEventListener('dragstart', function(event) {
          console.log('drag start on object: ', event.object);
          console.log('material: ', event.object.material);
          event.object.material.emissive.set(0xaaaaaa);
          activeObject = event.object;
          cameraControls.enabled = false;
        });
        controls.addEventListener('dragend', function(event) {
          event.object.material.emissive.set(0x000000);
          event.object.position.x = clamp(event.object.position.x, -4.0, 12.0);
          event.object.position.z = clamp(event.object.position.z, -4.0, 12.0);
          if (event.object.position.x < 0)
            event.object.position.x = round_to_precision(
              event.object.position.x,
              -4
            );
          else
            event.object.position.x = round_to_precision(
              event.object.position.x,
              4
            );
          if (event.object.position.z < 0)
            event.object.position.z = round_to_precision(
              event.object.position.z,
              -4
            );
          else
            event.object.position.z = round_to_precision(
              event.object.position.z,
              4
            );
          event.object.position.y = 0;
          console.log(event.object.position);
          cameraControls.enabled = true;
        });
      }

      function initRenderer() {
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.gammaOutput = true;
        renderer.gammaFactor = 2.2;
        renderer.setSize(WIDTH, HEIGHT);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setClearColor(0x888888, 1);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);
      }
      function initScene() {
        initCamera();

        var grid = new THREE.GridHelper(15, 4, 0x5b546c, 0x5b546c);
        grid.material.opacity = 0.8;
        grid.material.transparent = true;
        grid.position.set(-4, 5, -18.5);

        // Environment
        let envOLoader = new THREE.OBJLoader();
        let envMLoader = new THREE.MTLLoader();
        envMLoader.setPath('./assets/');
        envMLoader.load('environment.mtl', function(mtls) {
          mtls.preload();
          envOLoader.setMaterials(mtls);
          envOLoader.setPath('./assets/');
          envOLoader.load(
            'environment.obj',
            function(obj) {
              obj.receiveShadow = true;
              obj.position.set(0, 0, 0);
              obj.traverse(function(child) {
                if (child instanceof THREE.Mesh) {
                  child.receiveShadow = true;
                  child.material.shininess = 0;
                }
              });
              scene.add(obj);
              render();
            },
            function(xhr) {
              if (xhr.lengthComputable) {
                let percentComplete = (xhr.loaded / xhr.total) * 100;
                console.log(
                  'model' + Math.round(percentComplete, 2) + '% downloaded'
                );
              }
            },
            function() {}
          );
        });

        // Room
        let roomOLoader = new THREE.OBJLoader();
        let roomMLoader = new THREE.MTLLoader();
        roomMLoader.setPath('./assets/');
        roomMLoader.load('room.mtl', function(mtls) {
          mtls.preload();
          roomOLoader.setMaterials(mtls);
          roomOLoader.setPath('./assets/');
          roomOLoader.load(
            'room.obj',
            function(obj) {
              obj.receiveShadow = true;
              obj.position.set(0, 0, 0);
              scene.add(grid);
              obj.traverse(function(child) {
                if (child instanceof THREE.Mesh) {
                  child.receiveShadow = true;
                  child.material.shininess = 0;
                }
              });
              scene.add(obj);
              render();
            },
            function(xhr) {
              if (xhr.lengthComputable) {
                let percentComplete = (xhr.loaded / xhr.total) * 100;
                console.log(
                  'model' + Math.round(percentComplete, 2) + '% downloaded'
                );
              }
            },
            function() {}
          );
        });

        initLight();
      }

      function initCamera() {
        camera = new THREE.PerspectiveCamera(50, WIDTH / HEIGHT, 0.8, 1000);
        camera.position.set(-36, 33, -50);
        camera.lookAt(scene.position);
        cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
        cameraControls.addEventListener('change', function() {
          camera.updateProjectionMatrix();
          render();
        });
      }

      function initLight() {
        // var light = new THREE.HemisphereLight(0xffffff, 0x444444);
        // light.position.set(0, 10, 0);
        // scene.add(light);
        // var light = new THREE.HemisphereLight(0xffffff, 0x444444);
        // light.position.set(0, 20, 0);
        // scene.add(light);
        var light = new THREE.AmbientLight(0xffffff, 1);
        light.position.set(0, 20, 0);
        scene.add(light);
        let fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
        fillLight.position.set(10, 10, 10);
        scene.add(fillLight);
      }

      function initMeshes() {
        furnitureNames.forEach(piece => {
          console.log('about to load: ', piece);
          loadObject(piece);
        });
      }

      // When thumbnail is clicked, corresponding object is add to the scene.
      // Object is then deleted from the furniture map and reloaded to allow
      // for duplicates.
      function addPiece(name) {
        scene.add(furnitureMap.get(name));
        render();
        activeObject = furnitureMap.get(name);
        furnitureMap.delete(name);
        loadObject(name);
        handleWindowResize();
      }

      function swapTexture(name) {
        console.log('swap texture invoked');
        console.log('active object: ', activeObject);
        if (activeObject) {
          var texture = new THREE.TextureLoader().load(
            '/assets/textures/' + name + '.png'
          );
          var material = new THREE.MeshPhongMaterial({
            map: texture,
            shininess: 0
          });
          console.log(material);
          activeObject.material = material;
          render();
        }
      }

      function loadObject(name) {
        let objLoader = new THREE.OBJLoader();
        let mtlLoader = new THREE.MTLLoader();

        mtlLoader.setPath('./assets/');
        mtlLoader.load(name + '.mtl', function(mtls) {
          mtls.preload();
          objLoader.setMaterials(mtls);
          objLoader.setPath('./assets/');
          objLoader.load(
            name + '.obj',
            function(obj) {
              obj.traverse(function(child) {
                if (child instanceof THREE.Mesh) {
                  child.castShadow = true;
                  child.material.shininess = 0;
                }
              });
              obj.position.set(0, 0, 0);
              furnitureMap.set(name, obj);
              furnitureObjects.push(obj);
              uuidMap.set(obj.uuid, name);
            },
            function(xhr) {
              if (xhr.lengthComputable) {
                let percentComplete = (xhr.loaded / xhr.total) * 100;
                console.log(
                  name + ' ' + Math.round(percentComplete, 2) + '% downloaded'
                );
              }
            },
            function() {}
          );
        });
      }

      function handleWindowResize() {
        window.addEventListener('resize', function() {
          WIDTH = window.innerWidth;
          HEIGHT = window.innerHeight;
          renderer.setSize(WIDTH, HEIGHT);
          camera.aspect = WIDTH / HEIGHT;
          camera.updateProjectionMatrix();
          render();
        });
      }

      function animate() {
        requestAnimationFrame(animate);
        render();
      }

      function render() {
        renderer.render(scene, camera);
      }

      function round_to_precision(x, precision) {
        var y = +x + (precision === undefined ? 0.5 : precision / 2);
        return y - (y % (precision === undefined ? 1 : +precision));
      }

      function clamp(num, min, max) {
        return num <= min ? min : num >= max ? max : num;
      }

      init();
      animate();
    </script>
  </body>
</html>
